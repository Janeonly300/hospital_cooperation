<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="../../lib/layui/css/layui.css">
    <link rel="stylesheet" href="../../css/oksub.css">
    <link rel="stylesheet" href="../../myicon/iconfont.css" type="text/css">
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="../../css/oksub.css">
    <script src="../../lib/layui/layui.js"></script>
    <title>上传诊断</title>
</head>
<style>
    .list-con {
        padding: 0 10px 15px 10px;
        margin-bottom: 20px;
    }

    .list-con .layui-table td,
    .layui-table-view,
    .layui-table[lay-skin=line],
    .layui-table[lay-skin=row] {
        border: none;
    }

    .list-con .layui-table tbody {
        color: #777777;
    }

    .list-con .layui-table tbody tr:hover,
    .layui-table[lay-even] tr:nth-child(even) {
        background-color: rgb(226, 226, 226);
        color: black;
        font-weight: bold;
    }

    .layui-table tr {
        border-bottom: 1px #e2e2e2 solid;
    }

    .list-margin {
        margin-left: -30px;
    }

    .layui-table-tool-self {
        display: none;
    }

    .typeButton {
        height: 27px;
        vertical-align: middle;
        font-size: 13px;
        text-align: center;
        line-height: 27px;
    }

    .layui-btn-primary-inside {
        background-color: #1E9FFF;
        border: none;
        color: #FFF;
    }

    .layui-btn-normal-inside {
        background-color: #FFF;
        color: #1E9FFF;
        border: 1px solid #1E9FFF;
    }
</style>

<body>
<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>

<div class="ok-body">
    <div>
        <fieldset class="layui-elem-field">
            <legend>诊断申请</legend>
            <div style="background-color: #f8f8f8;height: auto;margin:15px 20px 0 30px">
                    <div class="layui-form-item">
                        <i class="tub layui-icon layui-icon-username" style="color: #1E9FFF;"></i>
                        <label>医院 : </label>
                        <span id="text_hos_name"></span>
                    </div>
                    <div class="layui-form-item">
                        <i class="tub layui-icon layui-icon-log" style="color: #FF5722;"></i>
                        <label>申请人 : </label>
                        <span id="text_doctor_name">xxx医院</span>
                    </div>
                    <div class="layui-form-item">
                        <i class="tub layui-icon layui-icon-diamond" style="color: #ff1e31;"></i>
                        <label>电话号码 : </label>
                        <span id="text_doctor_tel">2020-12-02 16:00</span>
                    </div>
            </div>
        </fieldset>
    </div>

    <div class="ok-body">
        <div class="layui-fluid">
            <div class="layui-card">
                <div class="layui-card-header">病人信息</div>
                <div class="layui-card-body" style="padding: 15px;">
                    <form class="layui-form" action="" lay-filter="component-form-group">
                        <div class="layui-form-item">
                            <label class="layui-form-label">患者名称</label>
                            <div class="layui-input-block">
                                <input type="text" name="patient_name" required lay-verify="required" placeholder="请输入名称" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">患者生日</label>
                            <div class="layui-input-block">
                                <input type="date" name="patient_birth" id="date" required lay-verify="required" placeholder="请选择患者生日" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">患者身高</label>
                            <div class="layui-input-block">
                                <input type="number" onblur="bmi_led()" onkeyup="this.value=this.value.replace(/\D/g,'')" name="patient_tall" required lay-verify="required" placeholder="请输入身高,单位cm" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">患者体重</label>
                            <div class="layui-input-block">
                                <input type="number" onblur="bmi_led()" onkeyup="this.value=this.value.replace(/\D/g,'')" name="patient_weight" required lay-verify="required" placeholder="请输入体重,单位kg" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">BMI</label>
                            <div class="layui-input-block">
                                <input type="number" readonly="true" style="background:#CCCCCC"  name="patient_BMI" required lay-verify="required" placeholder="自动计算、无需输入" class="layui-input" required lay-verify="required">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">所属科室</label>
                            <div class="layui-input-block">
                                <input type="text"  name="department" required lay-verify="required" placeholder="请输入所属科室" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea name="bz" placeholder="请输入内容" class="layui-textarea"></textarea>
                            </div>
                        </div>

                        <input id="files" name="files" value="0"  class="layui-input" type="hidden">
                        <div class="layui-upload">
                            <p>上传附件</p>
                            <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button>
                            <div class="layui-upload-list">
                                <table class="layui-table">
                                    <thead>
                                    <tr><th>文件名</th>
                                        <th>大小</th>
                                        <th>进度状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody id="demoList"></tbody>
                                </table>
                            </div>
                            <button type="button" class="layui-btn" id="testListAction" style="display: none">开始上传</button>
                        </div>

                        <div class="layui-form-item layui-layout-admin">
                            <div class="layui-input-block">
                                <div class="layui-footer" style="left: 0;">
                                    <button class="layui-btn" lay-submit="" lay-filter="add">立即提交</button>
                                    <button type="button" id="saveTemp" class="layui-btn layui-btn-primary">保存</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="../../lib/layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述 JS 路径需要改成你本地的 -->
<script>
    //计算BMI
    function bmi_led(){
        let tall = $("input[name='patient_tall']").val();
        let weight = $("input[name='patient_weight']").val();

        if(tall!==""&& weight!==""){
            tall /=100;
            let BMI = weight/(tall*tall)
            let steBmi = BMI+"";
            BMI = BMI.toFixed(1)
            //计算BMI值，填充到指定
            $("input[name='patient_BMI']").val(BMI)
        }
    }

    let disId = 0;
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        //执行一个laydate实例
        laydate.render({
            elem: '#date' //指定元素
        });

        $.ajax({
            url:"/getTempDisgnose_info",
            type:"get",
            async:true,
            success:function(obj){
                let dis = obj.data;
                let br;
                if(br !=null){
                    br= dis.patient_birth.substr(0,10)
                }

                // br = br.replaceAll("-","/")
                console.log(br)
                disId = dis.id;
                $("input[name='patient_name']").val(dis.patient_name)
                laydate.render({
                    elem: '#date'
                    ,value: br //必须遵循format参数设定的格式
                });
                let tall = parseInt(dis.patient_tall);
                let weight= parseInt(dis.patient_weight);
                let bmi = parseInt(dis.patient_BMI);
                $("input[name='patient_tall']").val(tall)
                $("input[name='patient_weight']").val(weight)
                $("input[name='department']").val(dis.department)
                $("input[name='bz']").val(dis.comment_text)
                $("input[name='patient_BMI']").val(bmi)
            }
        })
        //临时保存
        $("#saveTemp").on("click",function (){
           let bz =  $("input[name='bz']").val()
           let patient_name =  $("input[name='patient_name']").val()
           let patient_birth =  $("input[name='patient_birth']").val()
           let patient_tall =   $("input[name='patient_tall']").val()
           let patient_weight =  $("input[name='patient_weight']").val()
           let department =       $("input[name='department']").val()
           let patient_BMI =       $("input[name='patient_BMI']").val()
           //临时保存
            $.ajax({
                url:"/saveTempDisgnose_info?id="+disId,
                type:"POST",
                async:true,//异步加载
                data:{
                    bz,
                    patient_name,
                    patient_birth,
                    patient_tall,
                    patient_weight,
                    department,
                    patient_BMI
                },
                success:function (obj) {
                    if(obj["msg"]=="success"){
                        layer.msg("保存成功。", {
                            offset: ['50%'],
                            time: 1000 //1秒关闭（如果不配置，默认是3秒）
                        }, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            window.parent.$("#selectForm").click();
                            parent.layer.close(index);
                        });
                    }
                    if(obj["msg"]=="error"){
                        alert("保存失败");
                    }
                }
            });
            return false;
        });
    });

    layui.use(['form','layer','element'], function(){
        $ = layui.jquery;
        var form = layui.form,layer = layui.layer;

        //监听提交
        form.on('submit(add)', function(data){
            console.log(data.field.files);
            $.ajax({
                url:"/saveDisgnose_info?id="+disId,
                type:"post",
                async:true,//异步加载
                data:data.field,
                success:function (obj) {
                    if(obj["msg"]=="success"){
                        layer.msg("提交成功。", {
                            offset: ['50%'],
                            time: 1000 //1秒关闭（如果不配置，默认是3秒）
                        }, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            window.parent.$("#selectForm").click();
                            parent.layer.close(index);
                        });

                    }
                    if(obj["msg"]=="error"){
                        alert("error");
                    }
                }
            });
            return false;
        });
    });
    var tempId = 1;
    var done_id = 0;
    var arr_p=[]; //
    var arr_pv=[];
    //文件上传
    var files=[];
    //JavaScript代码区域
    layui.use(['element','upload'], function(){
        var $ = layui.jquery
            ,upload = layui.upload;

        //上传
        //多文件列表示例
        // var demoListView = $('#demoList')
        //     ,uploadListIns = upload.render({
        //     elem: '#testList'
        //     ,url: '/fileUpload' //改成您自己的上传接口
        //     ,accept: 'file'
        //     // ,exts: 'txt|rar|zip|doc|docx|pdf|xls|xlsx' //允许上传的文件类型
        //     ,multiple: true
        //     ,auto: false
        //     ,bindAction: '#testListAction'
        //     ,choose: function(obj){
        //         var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
        //         //读取本地文件
        //         obj.preview(function(index, file, result){
        //             var tr = $(['<tr id="upload-'+ index +'">'
        //                 ,'<td>'+ file.name +'</td>'
        //                 ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
        //                 ,'<td>等待上传</td>'
        //                 ,'<td>'
        //                 ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
        //                 ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
        //                 ,'</td>'
        //                 ,'</tr>'].join(''));
        //
        //             //单个重传
        //             tr.find('.demo-reload').on('click', function(){
        //                 obj.upload(index, file);
        //             });
        //
        //             //删除
        //             tr.find('.demo-delete').on('click', function(){
        //                 delete files[index]; //删除对应的文件
        //                 tr.remove();
        //                 uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
        //             });
        //
        //             demoListView.append(tr);
        //         });
        //     }
        //     ,done: function(res, index, upload){
        //         if (res.code == 0){
        //             files.push({"fileName":res.filename,"fileUrl":res.fileUrl,"fileSize":res.fileSize});//,"fileUrl":res.fileUrl
        //             var json = JSON.stringify(files);
        //             //将上传的文件信息加入到集合中并转换成json字符串
        //             $("#fileJson").attr("value",json);
        //
        //             var fileUrl = res.fileUrl;
        //             var tr = demoListView.find('tr#upload-'+ index)
        //                 ,tds = tr.children();
        //             tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
        //             tds.eq(3).html('<span>'+fileUrl+'</span>');
        //             tds.eq(4).html(''); //清空操作
        //             return delete this.files[index]; //删除文件队列已经上传成功的文件
        //         }
        //         this.error(index, upload);
        //     }
        //     ,error: function(index, upload){
        //         var tr = demoListView.find('tr#upload-'+ index)
        //             ,tds = tr.children();
        //         tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
        //         tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
        //     }
        // });
        element = layui.element
        //演示多文件列表

        var uploadListIns = upload.render({
            elem: '#testList'
            ,elemList: $('#demoList') //列表元素对象
            ,url: '/fileUpload' //此处用的是第三方的 http 请求演示，实际使用时改成您自己的上传接口即可。
            ,accept: 'file'
            ,multiple: false
            ,number: 100
            ,auto: true
            ,bindAction: '#testListAction'
            ,choose: function(obj){
                var that = this;
                var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                var progress = "<td><progress id='p_"+tempId+"' value= '0'  max= '100' ></progress></td>";
                for(let y=0;y<obj.upload.length;y++)
                {
                    arr_p.push(tempId);
                    arr_pv.push(0);
                    tempId++;
                }

                let i = 1;
                setInterval(function(){
                    for(let x=0;x<arr_p.length;x++)
                    {
                        let v = arr_pv[x];
                        if(v>=99)
                            continue;
                        let id = "#p_"+arr_p[x];
                        arr_pv[x] += 5;
                        $(id).val(v);
                    }
                    i++;
                },1000);

                //读取本地文件
                obj.preview(function(index, file, result){
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
                        ,progress
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.demo-reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    that.elemList.append(tr);
                    element.render('progress'); //渲染新加的进度条组件
                });


            }
            ,done: function(res, index, upload){ //成功的回调
                var that = this;
                //if(res.code == 0){ //上传成功
                var tr = that.elemList.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(3).html(''); //清空操作
                // delete this.files[index]; //删除文件队列已经上传成功的文件
                // return;
                // //}
                // this.error(index, upload);
                arr_pv[done_id] = 100;
                done_id++;

                let id = "#p_"+done_id;
                $(id).val(100);

            }
            ,allDone: function(obj){ //多文件上传完毕后的状态回调
                console.log(obj)
            }
            ,error: function(index, upload){ //错误回调
                var that = this;
                var tr = that.elemList.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
            }
            ,progress: function(n, elem, res, index){
                var percent = n + '%' //获取进度百分比
                element.progress('demo', percent); //可配合 layui 进度条元素使用

                console.log(elem); //得到当前触发的元素 DOM 对象。可通过该元素定义的属性值匹配到对应的进度条。
                console.log(res); //得到 progress 响应信息
                console.log(index); //得到当前上传文件的索引，多文件上传时的进度条控制，如：
                element.progress('demo-'+ index, n + '%'); //进度条
            }
        });
        var i  =  1;
    });

</script>

</body>
<script src="../../js/jquery.min.js"></script>
<script src="../../js/application.js"></script>
<script>

    layui.use('jquery',function(){
        var $ = layui.jquery;
        var width = $(window).width();

        $.ajax({
            // url: '../php/creatSceneXml.php',
            url: '/getInfo',
            type: 'GET'
        })
            .done(function (result) {
                console.log(result)
                $('#text_doctor_name').text(result.doctor_name)
                $("#text_hos_name").text(result.doctor_account)
                $("#text_doctor_tel").text(result.doctor_tel)

            })
            .fail(function () {
                console.log("error");
            })
            .always(function () {
                console.log("complete");
            });

    })

    var selectType = "0"; //按钮状态


</script>
</html>